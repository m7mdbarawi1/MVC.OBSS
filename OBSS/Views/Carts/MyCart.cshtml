@model List<OBSS.Models.CartDetail>
@{
    ViewData["Title"] = "My Cart";
    decimal totalPrice = Model.Sum(cd => cd.Book.Price * cd.Quantity);
}
@if (TempData["Info"] != null)
{
    <div class="alert alert-info">@TempData["Info"]</div>
}

<h1>My Cart</h1>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (!Model.Any())
{
    <p>Your cart is empty.</p>
}
else
{
    <table class="table table-bordered table-striped" id="cartTable">
        <thead>
            <tr>
                <th>Book</th>
                <th>Author</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr data-book-id="@item.BookId">
                    <td>@item.Book.BookTitle</td>
                    <td>@item.Book.Author</td>
                    <td>@item.Book.Category?.CategoryDesc</td>
                    <td>
                        <input type="number" min="1" value="@item.Quantity" class="form-control qty-input" style="width:80px;" />
                    </td>
                    <td class="item-price">@((item.Book.Price * item.Quantity).ToString("C"))</td>
                    <td>
                        <form asp-action="RemoveFromCart" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="bookId" value="@item.BookId" />
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <h3>Total: <span id="totalPrice">@totalPrice.ToString("C")</span></h3>

    <form asp-action="Purchase" method="post">
        @Html.AntiForgeryToken()
        <button type="submit" class="btn btn-success btn-lg">Purchase</button>
    </form>
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(".qty-input").on("input", function () {
            let row = $(this).closest("tr");
            let bookId = row.data("book-id");
            let quantity = $(this).val();

            $.post("@Url.Action("UpdateQuantity", "Carts")", { bookId, quantity }, function (data) {
                if (data.success) {
                    row.find(".item-price").text(data.itemPrice.toLocaleString('en-US', { style: 'currency', currency: 'USD' }));
                    $("#totalPrice").text(data.totalPrice.toLocaleString('en-US', { style: 'currency', currency: 'USD' }));
                }
            });
        });
    </script>
}
